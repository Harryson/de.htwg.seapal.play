<!DOCTYPE html>
<html>
    <head lang="en">
        @logbookContent.header()
        <script type="text/javascript">
            
            $(document).ready(function () {
            	
            	/*  ---------------  backend tests  -------------- */
                    
            	// callback for logbook.getTripPhotos()
            	function onReceivedTripPhotos(tripId, pictures) {
            		var picturesCount = $('#flipsterContainer div').children().length;
            		// appended newly loaded pictures to flipster template
            		$.each(pictures, function (index, value) {
            			var imgId = 'img' + value.waypointId;
            			var imgNode = $('<li><img id="' + imgId + '" data-waypoint="' + value.waypointId + '" class="waypointImg"/></li>');
            			$('#flipsterTemplate ul').append(imgNode);
            			$('#' + imgId).attr('src', value.thumbPicture);
            		});
            		// copy template to flipster bar
            		$('#flipsterContainer').html($('#flipsterTemplate').html());
            		// enable coverflow
            		$('#flipsterContainer div').flipster({
                        style: "coverflow",
                        start: picturesCount - 1
                    });
            	}
            	
            	// callback for logbook.getTripWaypoints()
            	function onReceivedWaypoints(tripId, waypoints) {
            		alert('count: ' + waypoints.length);
            	}
            	
            	$('#btnPicApiTest').click(function () {
            		logbook.getTripPhotos($('#txtTripId').val(), 0, 5, onReceivedTripPhotos);
            	});
            	
            	$('#btnTripApiTest').click(function () { 
            		logbook.getTripData($('#txtTripId').val(), function (tripId, tripData) {
            			alert(JSON.stringify(tripData));
            		})
            	});
            	
            	$('#btnTripApiTest2').click(function () { 
            		logbook.getTripWaypoints($('#txtTripId').val(), 0, 5, onReceivedWaypoints);
            	});
            	
            	$('#btnTripApiTest3').click(function () { 
            		logbook.getWaypointData($('#txtTripId').val(), function (waypointId, waypointData) {
            			alert(JSON.stringify(waypointData));
            		});
            	});
            	
            	$('#flipsterContainer').on('click', '.waypointImg', function () {
            		var url = logbook.getPhotoOfWaypoint($(this).attr('data-waypoint'));
            		window.location = url;
            	});



                // actual script
                $('#entries_col' ).css('padding-top', $('#menu_bar' ).css('height'));
                $('#details_col' ).css('padding-top', $('#menu_bar' ).css('height'));
                $('#timeline_col' ).css('padding-top', $('#menu_bar' ).css('height'));

                $('.sticky' ).stick_in_parent();

                $('.accordion .head').click(function() {
                    $(this).next().toggle("slow");
                    return false;
                });

                //timeline
                $(".timeline-panel.clickable" ).each(function(){
                    $(this ).click(function(){
                        var index = $(this).attr("id");
                        index = index.replace('timeline-','');
                        var entry = $("#"+index);
                        //console.log("index: "+index);
                        var targetOffset = entry.offset().top - 50;

                        $('html,body').animate({
                            scrollTop: targetOffset
                        },{
                            complete: function() { activeEntryChanged(entry); }
                        },
                        'slow'
                        );
                    });
                });

                $(".timeline-panel.expandable" ).each(function(){
                    $(this ).click(function(){
                        var index = $(this).attr("id");
                        index = index.replace('timeline-','');
                        //console.log("index: "+index);
                        $('#expandable-'+index ).toggle("slow");
                    });
                });

                $('#viewport').dragscrollable();

                //waypoint - detect, which entry is active
                var offset_up = $('#menu_bar' ).height()-1;
                var offset_down = offset_up+parseInt($('.logbookEntry').css('min-height'));

                $('.logbookEntry' ).waypoint(function(direction) {
                    if(direction == "down"){
                        activeEntryChanged($(this));
                    }
                }, { offset: offset_down });

                $('.logbookEntry' ).waypoint(function(direction) {
                    if(direction == "up"){
                        activeEntryChanged($(this));
                    }
                }, { offset: offset_up });

                if($('.logbookEntry.active').length <= 0){
                    activeEntryChanged($('.logbookEntry' ).first());
                }
            });

            function activeEntryChanged(activeEntry){
                //console.log("active entry: "+activeEntry.attr("id"));
                $('.logbookEntry').removeClass("active");
                activeEntry.addClass("active");
            }
        </script>
    </head>
    <body>
        <div id="menu_bar">
            @logbookContent.menubar()
        </div>
        <div id="timeline_col">
            @logbookContent.timeline()
        </div>
        <div class="container">
            <div class="row">
                <div id="entries_col" class="span6">
                    @logbookContent.entries()
                </div>
                <div id="details_col" class="span4 sticky">
                    @logbookContent.details()
                </div>
            </div>
        </div>
    </body>
</html>